<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¶ Fake Bank - Family Game Banking System</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .content {
            padding: 30px;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #4facfe;
        }

        .btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        }

        .nav-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 20px;
        }

        .nav-buttons .btn {
            margin-bottom: 0;
        }

        .user-info {
            text-align: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .account-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 15px;
            text-align: center;
        }

        .account-number {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .balance {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
        }

        .transaction {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #4facfe;
        }

        .transaction.incoming {
            border-left-color: #28a745;
        }

        .transaction.outgoing {
            border-left-color: #dc3545;
        }

        .transaction-amount.positive {
            color: #28a745;
            font-weight: bold;
        }

        .transaction-amount.negative {
            color: #dc3545;
            font-weight: bold;
        }

        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-weight: 500;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4facfe;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .recurring-payment-card {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
        }

        .recurring-payment-card h4 {
            color: #856404;
            margin-bottom: 10px;
        }

        .recurring-payment-info {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }

        .frequency-badge {
            background: #007bff;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
        }

        @media (max-width: 480px) {
            .container {
                margin: 0;
                border-radius: 0;
                min-height: 100vh;
            }
            
            body {
                padding: 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Fake Bank</h1>
            <p>Family Game Banking System</p>
        </div>

        <div class="content">
            <!-- Login Screen -->
            <div id="loginScreen" class="screen active">
                <div class="form-group">
                    <label for="username">Username</label>
                    <input type="text" id="username" placeholder="Enter your username">
                </div>
                <div class="form-group">
                    <label for="pin">PIN (4 digits)</label>
                    <input type="password" id="pin" maxlength="4" placeholder="Enter your 4-digit PIN">
                </div>
                <button class="btn" onclick="login()">Login</button>
                <button class="btn btn-secondary" onclick="showRegister()">Create New Account</button>
            </div>

            <!-- Register Screen -->
            <div id="registerScreen" class="screen">
                <div class="form-group">
                    <label for="newUsername">Username</label>
                    <input type="text" id="newUsername" placeholder="Choose a username">
                </div>
                <div class="form-group">
                    <label for="newPin">PIN (4 digits)</label>
                    <input type="password" id="newPin" maxlength="4" placeholder="Choose a 4-digit PIN">
                </div>
                <div class="form-group">
                    <label for="accountType">Account Type</label>
                    <select id="accountType">
                        <option value="personal">Personal Account</option>
                        <option value="business">Business Account</option>
                    </select>
                </div>
                <button class="btn" onclick="register()">Create Account</button>
                <button class="btn btn-secondary" onclick="showLogin()">Back to Login</button>
            </div>

            <!-- Dashboard Screen -->
            <div id="dashboardScreen" class="screen">
                <div class="user-info">
                    <h3>Welcome, <span id="currentUser"></span>!</h3>
                </div>

                <div class="nav-buttons">
                    <button class="btn" onclick="showTransfer()">Transfer Money</button>
                    <button class="btn btn-secondary" onclick="showCharge()">Charge Customer</button>
                </div>

                <div class="nav-buttons" id="businessButtons" style="display: none;">
                    <button class="btn" onclick="showRecurringPayments()">Salary Payments</button>
                    <button class="btn btn-secondary" onclick="showCreateRecurring()">Setup Salary</button>
                </div>

                <div id="accountsList"></div>

                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>

            <!-- Transfer Screen -->
            <div id="transferScreen" class="screen">
                <h3>Transfer Money</h3>
                <div class="form-group">
                    <label for="fromAccount">From Account</label>
                    <select id="fromAccount"></select>
                </div>
                <div class="form-group">
                    <label for="toAccountNumber">To Account Number</label>
                    <input type="text" id="toAccountNumber" placeholder="Enter recipient's account number">
                </div>
                <div class="form-group">
                    <label for="transferAmount">Amount</label>
                    <input type="number" id="transferAmount" step="0.01" placeholder="Enter amount">
                </div>
                <div class="form-group">
                    <label for="transferDescription">Description (optional)</label>
                    <input type="text" id="transferDescription" placeholder="What's this for?">
                </div>
                <button class="btn" onclick="transfer()">Send Money</button>
                <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            </div>

            <!-- Charge Screen -->
            <div id="chargeScreen" class="screen">
                <h3>Charge Customer</h3>
                <div class="form-group">
                    <label for="businessAccount">Business Account</label>
                    <select id="businessAccount"></select>
                </div>
                <div class="form-group">
                    <label for="customerUsername">Customer Username</label>
                    <input type="text" id="customerUsername" placeholder="Customer's username">
                </div>
                <div class="form-group">
                    <label for="customerPin">Customer PIN</label>
                    <input type="password" id="customerPin" maxlength="4" placeholder="Customer's PIN">
                </div>
                <div class="form-group">
                    <label for="chargeAmount">Amount</label>
                    <input type="number" id="chargeAmount" step="0.01" placeholder="Enter charge amount">
                </div>
                <div class="form-group">
                    <label for="chargeReason">Reason for Charge</label>
                    <input type="text" id="chargeReason" placeholder="Why are you charging them?" required>
                </div>
                <div class="form-group">
                    <label for="chargeDescription">Additional Details (optional)</label>
                    <input type="text" id="chargeDescription" placeholder="Any extra details?">
                </div>
                <button class="btn" onclick="charge()">Charge Customer</button>
                <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            </div>

            <!-- Create Recurring Payment Screen -->
            <div id="createRecurringScreen" class="screen">
                <h3>Setup Salary Payment</h3>
                <div class="form-group">
                    <label for="recurringBusinessAccount">Business Account</label>
                    <select id="recurringBusinessAccount"></select>
                </div>
                <div class="form-group">
                    <label for="recipientAccountNumber">Employee Account Number</label>
                    <input type="text" id="recipientAccountNumber" placeholder="Enter employee's account number">
                </div>
                <div class="form-group">
                    <label for="salaryAmount">Salary Amount</label>
                    <input type="number" id="salaryAmount" step="0.01" placeholder="Enter salary amount">
                </div>
                <div class="form-group">
                    <label for="salaryDescription">Description</label>
                    <input type="text" id="salaryDescription" placeholder="e.g., Monthly Salary" value="Monthly Salary">
                </div>
                <div class="form-group">
                    <label for="paymentFrequency">Payment Frequency</label>
                    <select id="paymentFrequency">
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected>Monthly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <button class="btn" onclick="createRecurringPayment()">Setup Salary Payment</button>
                <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            </div>

            <!-- Recurring Payments Screen -->
            <div id="recurringPaymentsScreen" class="screen">
                <h3>Salary Payments</h3>
                <div id="recurringPaymentsList"></div>
                <button class="btn" onclick="processRecurringPayments()">Process Due Payments</button>
                <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            </div>

            <!-- Transactions Screen -->
            <div id="transactionsScreen" class="screen">
                <h3>Transaction History</h3>
                <div id="transactionsList"></div>
                <button class="btn btn-secondary" onclick="showDashboard()">Back</button>
            </div>

            <!-- Alert Container -->
            <div id="alertContainer"></div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let userAccounts = [];

        // Utility functions
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
        }

        function showAlert(message, type = 'success') {
            const alertContainer = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 5000);
        }

        function formatCurrency(amount) {
            return '$' + parseFloat(amount).toFixed(2);
        }

        // API functions
        async function apiCall(endpoint, method = 'GET', data = null) {
            const options = {
                method,
                headers: {
                    'Content-Type': 'application/json',
                },
            };

            if (data) {
                options.body = JSON.stringify(data);
            }

            try {
                const response = await fetch(`/api${endpoint}`, options);
                const result = await response.json();
                
                if (!response.ok) {
                    throw new Error(result.error || 'Something went wrong');
                }
                
                return result;
            } catch (error) {
                showAlert(error.message, 'error');
                throw error;
            }
        }

        // Authentication functions
        async function login() {
            const username = document.getElementById('username').value;
            const pin = document.getElementById('pin').value;

            if (!username || !pin) {
                showAlert('Please enter both username and PIN', 'error');
                return;
            }

            try {
                const result = await apiCall('/login', 'POST', { username, pin });
                currentUser = result.user;
                userAccounts = result.accounts;
                
                document.getElementById('currentUser').textContent = currentUser.username;
                loadDashboard();
                showScreen('dashboardScreen');
                showAlert('Login successful!');
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        async function register() {
            const username = document.getElementById('newUsername').value;
            const pin = document.getElementById('newPin').value;
            const accountType = document.getElementById('accountType').value;

            if (!username || !pin) {
                showAlert('Please enter both username and PIN', 'error');
                return;
            }

            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showAlert('PIN must be exactly 4 digits', 'error');
                return;
            }

            try {
                const result = await apiCall('/register', 'POST', { username, pin, account_type: accountType });
                showAlert('Account created successfully! You can now login.');
                showLogin();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        async function logout() {
            try {
                await apiCall('/logout', 'POST');
                currentUser = null;
                userAccounts = [];
                showLogin();
                showAlert('Logged out successfully');
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Dashboard functions
        function loadDashboard() {
            const accountsList = document.getElementById('accountsList');
            accountsList.innerHTML = '';

            // Check if user has business accounts
            const hasBusinessAccount = userAccounts.some(account => account.account_type === 'business');
            const businessButtons = document.getElementById('businessButtons');
            businessButtons.style.display = hasBusinessAccount ? 'block' : 'none';

            userAccounts.forEach(account => {
                const accountCard = document.createElement('div');
                accountCard.className = 'account-card';
                accountCard.innerHTML = `
                    <div class="account-number">${account.account_number}</div>
                    <div style="text-transform: capitalize; color: rgba(255,255,255,0.8); margin: 5px 0;">${account.account_type} Account</div>
                    <div class="balance">${formatCurrency(account.balance)}</div>
                    <button class="btn" onclick="showTransactions(${account.id})" style="margin-top: 10px;">View Transactions</button>
                `;
                accountsList.appendChild(accountCard);
            });

            // Populate account dropdowns
            populateAccountDropdowns();
        }

        function populateAccountDropdowns() {
            const fromAccountSelect = document.getElementById('fromAccount');
            const businessAccountSelect = document.getElementById('businessAccount');
            const recurringBusinessAccountSelect = document.getElementById('recurringBusinessAccount');
            
            fromAccountSelect.innerHTML = '';
            businessAccountSelect.innerHTML = '';
            recurringBusinessAccountSelect.innerHTML = '';

            userAccounts.forEach(account => {
                const option = document.createElement('option');
                option.value = account.account_number;
                option.textContent = `${account.account_number} (${formatCurrency(account.balance)})`;
                fromAccountSelect.appendChild(option.cloneNode(true));

                if (account.account_type === 'business') {
                    businessAccountSelect.appendChild(option.cloneNode(true));
                    recurringBusinessAccountSelect.appendChild(option.cloneNode(true));
                }
            });
        }

        // Transfer functions
        async function transfer() {
            const fromAccountNumber = document.getElementById('fromAccount').value;
            const toAccountNumber = document.getElementById('toAccountNumber').value;
            const amount = document.getElementById('transferAmount').value;
            const description = document.getElementById('transferDescription').value;

            if (!fromAccountNumber || !toAccountNumber || !amount) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const result = await apiCall('/transfer', 'POST', {
                    from_account_number: fromAccountNumber,
                    to_account_number: toAccountNumber,
                    amount: parseFloat(amount),
                    description
                });

                showAlert('Transfer successful!');
                
                // Update account balance
                const account = userAccounts.find(acc => acc.account_number === fromAccountNumber);
                if (account) {
                    account.balance = result.new_balance;
                }
                
                loadDashboard();
                showDashboard();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Charge functions
        async function charge() {
            const businessAccountNumber = document.getElementById('businessAccount').value;
            const customerUsername = document.getElementById('customerUsername').value;
            const customerPin = document.getElementById('customerPin').value;
            const amount = document.getElementById('chargeAmount').value;
            const reason = document.getElementById('chargeReason').value;
            const description = document.getElementById('chargeDescription').value;

            if (!businessAccountNumber || !customerUsername || !customerPin || !amount || !reason) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const result = await apiCall('/charge', 'POST', {
                    business_account_number: businessAccountNumber,
                    customer_username: customerUsername,
                    customer_pin: customerPin,
                    amount: parseFloat(amount),
                    reason: reason,
                    description: description
                });

                showAlert('Customer charged successfully!');
                
                // Update account balance
                const account = userAccounts.find(acc => acc.account_number === businessAccountNumber);
                if (account) {
                    account.balance = result.business_new_balance;
                }
                
                loadDashboard();
                showDashboard();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Recurring payment functions
        async function createRecurringPayment() {
            const businessAccountNumber = document.getElementById('recurringBusinessAccount').value;
            const recipientAccountNumber = document.getElementById('recipientAccountNumber').value;
            const amount = document.getElementById('salaryAmount').value;
            const description = document.getElementById('salaryDescription').value;
            const frequency = document.getElementById('paymentFrequency').value;

            if (!businessAccountNumber || !recipientAccountNumber || !amount) {
                showAlert('Please fill in all required fields', 'error');
                return;
            }

            try {
                const result = await apiCall('/recurring_payments', 'POST', {
                    business_account_number: businessAccountNumber,
                    recipient_account_number: recipientAccountNumber,
                    amount: parseFloat(amount),
                    description: description,
                    frequency: frequency
                });

                showAlert('Salary payment setup successfully!');
                showDashboard();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        async function loadRecurringPayments() {
            try {
                const payments = await apiCall('/recurring_payments', 'GET');
                const paymentsList = document.getElementById('recurringPaymentsList');
                paymentsList.innerHTML = '';

                if (payments.length === 0) {
                    paymentsList.innerHTML = '<p style="text-align: center; color: #666;">No salary payments set up yet</p>';
                } else {
                    payments.forEach(payment => {
                        const paymentCard = document.createElement('div');
                        paymentCard.className = 'recurring-payment-card';
                        
                        const nextPaymentDate = new Date(payment.next_payment_date).toLocaleDateString();
                        
                        paymentCard.innerHTML = `
                            <h4>üí∞ ${payment.description}</h4>
                            <div class="recurring-payment-info">
                                <span>To: ${payment.recipient_username}</span>
                                <span class="frequency-badge">${payment.frequency}</span>
                            </div>
                            <div class="recurring-payment-info">
                                <span>Amount: ${formatCurrency(payment.amount)}</span>
                                <span>Next: ${nextPaymentDate}</span>
                            </div>
                            <div class="recurring-payment-info">
                                <span>Status: ${payment.is_active ? '‚úÖ Active' : '‚ùå Cancelled'}</span>
                                ${payment.is_active ? `<button class="btn btn-danger" onclick="cancelRecurringPayment(${payment.id})" style="padding: 5px 10px; font-size: 12px; margin: 0;">Cancel</button>` : ''}
                            </div>
                        `;
                        paymentsList.appendChild(paymentCard);
                    });
                }
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        async function cancelRecurringPayment(paymentId) {
            if (!confirm('Are you sure you want to cancel this salary payment?')) {
                return;
            }

            try {
                await apiCall(`/recurring_payments/${paymentId}`, 'DELETE');
                showAlert('Salary payment cancelled successfully!');
                loadRecurringPayments();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        async function processRecurringPayments() {
            try {
                const result = await apiCall('/process_recurring_payments', 'POST');
                showAlert(`Processed ${result.processed} payments, ${result.failed} failed`);
                loadDashboard();
                loadRecurringPayments();
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Transaction functions
        async function showTransactions(accountId) {
            try {
                const transactions = await apiCall(`/accounts/${accountId}/transactions`);
                const transactionsList = document.getElementById('transactionsList');
                transactionsList.innerHTML = '';

                if (transactions.length === 0) {
                    transactionsList.innerHTML = '<p style="text-align: center; color: #666;">No transactions yet</p>';
                } else {
                    transactions.forEach(transaction => {
                        const isIncoming = transaction.to_account_id === accountId;
                        const transactionDiv = document.createElement('div');
                        transactionDiv.className = `transaction ${isIncoming ? 'incoming' : 'outgoing'}`;
                        
                        const date = new Date(transaction.created_at).toLocaleDateString();
                        const time = new Date(transaction.created_at).toLocaleTimeString();
                        
                        let typeLabel = 'Transfer';
                        if (transaction.transaction_type === 'charge') typeLabel = 'Charge';
                        if (transaction.transaction_type === 'salary') typeLabel = 'Salary';
                        
                        transactionDiv.innerHTML = `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold;">${typeLabel}</div>
                                    <div style="color: #666; font-size: 12px;">${date} ${time}</div>
                                    ${transaction.description ? `<div style="color: #666; font-size: 14px;">${transaction.description}</div>` : ''}
                                </div>
                                <div class="transaction-amount ${isIncoming ? 'positive' : 'negative'}">
                                    ${isIncoming ? '+' : '-'}${formatCurrency(transaction.amount)}
                                </div>
                            </div>
                        `;
                        transactionsList.appendChild(transactionDiv);
                    });
                }

                showScreen('transactionsScreen');
            } catch (error) {
                // Error already shown by apiCall
            }
        }

        // Navigation functions
        function showLogin() {
            showScreen('loginScreen');
            document.getElementById('username').value = '';
            document.getElementById('pin').value = '';
        }

        function showRegister() {
            showScreen('registerScreen');
            document.getElementById('newUsername').value = '';
            document.getElementById('newPin').value = '';
        }

        function showDashboard() {
            showScreen('dashboardScreen');
        }

        function showTransfer() {
            showScreen('transferScreen');
            document.getElementById('toAccountNumber').value = '';
            document.getElementById('transferAmount').value = '';
            document.getElementById('transferDescription').value = '';
        }

        function showCharge() {
            showScreen('chargeScreen');
            document.getElementById('customerUsername').value = '';
            document.getElementById('customerPin').value = '';
            document.getElementById('chargeAmount').value = '';
            document.getElementById('chargeReason').value = '';
            document.getElementById('chargeDescription').value = '';
        }

        function showCreateRecurring() {
            showScreen('createRecurringScreen');
            document.getElementById('recipientAccountNumber').value = '';
            document.getElementById('salaryAmount').value = '';
            document.getElementById('salaryDescription').value = 'Monthly Salary';
        }

        function showRecurringPayments() {
            showScreen('recurringPaymentsScreen');
            loadRecurringPayments();
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            showLogin();
        });
    </script>
</body>
</html>

